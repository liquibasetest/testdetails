import boto3
import csv

# Initialize the Lake Formation client
lf_client = boto3.client('lakeformation')

# Specify the name of the Lake Formation catalog
catalog_name = 'my-catalog'

# Specify the output CSV file path
output_csv_file = 'lake_formation_permissions.csv'

try:
    # Get the list of databases in the catalog
    database_response = lf_client.list_databases(CatalogId='account-id', CatalogName=catalog_name)

    # Prepare the CSV file for writing
    with open(output_csv_file, 'w', newline='') as csv_file:
        fieldnames = ['Principal', 'Principal Type', 'Principal ARN', 'Database', 'Table', 'Permissions', 'Grantable']
        csv_writer = csv.DictWriter(csv_file, fieldnames=fieldnames, delimiter='|')
        csv_writer.writeheader()

        # Iterate through the list of databases
        for database in database_response['DatabaseList']:
            database_name = database['Name']

            # Get the list of tables in the database
            table_response = lf_client.list_tables(CatalogId='account-id', DatabaseName=database_name)

            for table in table_response['TableList']:
                table_name = table['Name']

                # Get the permissions for the table
                permissions_response = lf_client.list_permissions(CatalogId='account-id', DatabaseName=database_name, TableWithColumns={'DatabaseName': database_name, 'Name': table_name})

                for permission in permissions_response['PrincipalResourcePermissions']:
                    principal = permission['Principal']['DataLakePrincipalIdentifier']
                    principal_type = permission['Principal']['Type']
                    principal_arn = permission['Principal']['Identifier']
                    permissions = ', '.join(permission['Permissions'])
                    grantable = permission['PermissionsWithGrantOption']

                    csv_writer.writerow({
                        'Principal': principal,
                        'Principal Type': principal_type,
                        'Principal ARN': principal_arn,
                        'Database': database_name,
                        'Table': table_name,
                        'Permissions': permissions,
                        'Grantable': grantable
                    })

    print("CSV output written to", output_csv_file)

except Exception as e:
    print("Error:", e)
